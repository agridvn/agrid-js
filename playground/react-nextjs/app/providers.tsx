'use client'

import agrid, { CaptureResult } from 'agrid-js'
import { AgridProvider } from '@agrid/react'
import React, { useEffect, useState } from 'react'
import { EventDisplay } from './EventDisplay'

let eventListeners: ((event: CaptureResult | null) => void)[] = []

export function addEventListener(callback: (event: CaptureResult | null) => void) {
    eventListeners.push(callback)
    return () => {
        eventListeners = eventListeners.filter((cb) => cb !== callback)
    }
}

if (typeof window !== 'undefined') {
    agrid.init('agc_test_key_for_playground', {
        api_host: 'https://app.agrid.vn',
        person_profiles: 'identified_only',
        capture_pageview: 'history_change',
        capture_pageleave: true,
        before_send: (event: CaptureResult | null) => {
            eventListeners.forEach((callback) => callback(event))
            console.log('Yo! An event', event?.event, event)
            return event
        },
    })
}

export function AgridWrapper({ children }: { children: React.ReactNode }) {
    const [events, setEvents] = useState<CaptureResult[]>([])

    useEffect(() => {
        const removeListener = addEventListener((event) => {
            if (!event) {
                return
            }
            setEvents((prev: CaptureResult[]) => [event, ...prev].slice(0, 10))
        })

        agrid.capture('playground_loaded')

        return removeListener
    }, [])

    return (
        <AgridProvider client={agrid}>
            <EventDisplay events={events} />
            {children}
        </AgridProvider>
    )
}
